option_settings:
  aws:elasticbeanstalk:application:environment:
    # Database environment variables will be overridden by environment-specific settings
    POSTGRES_PORT: 5432
    POSTGRES_DB: alphavox

Resources:
  # Security group for RDS instances
  AWSEBRDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS DB Instance
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: { "Fn::GetAtt": ["AWSEBSecurityGroup", "GroupId"] }

container_commands:
  01_migrate_database:
    command: |
      # Wait for the database to be available
      python scripts/wait_for_db.py
      
      # Run database migrations
      python scripts/db_migrate.py
    leader_only: true